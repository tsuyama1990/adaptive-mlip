version: '3.8'

services:
  ac-cdd:
    image: ac-cdd
    container_name: ac-cdd-agent

    # Mount current directory to /app
    volumes:
      - .:/app

      # Git authentication - SSH keys only (not .gitconfig to avoid conflicts)
      - ${HOME}/.ssh:/root/.ssh:ro

      # SSH Agent socket (for SSH agent forwarding)
      - ${SSH_AUTH_SOCK:-/dev/null}:${SSH_AUTH_SOCK:-/dev/null}
      # Optional: Mount global config if exists
      # - ${HOME}/.ac_cdd/.env:/root/.ac_cdd/.env



    environment:
      # Pass Host UID/GID to fix permission issues
      - HOST_UID=${UID:-1000}
      - HOST_GID=${GID:-1000}

      # SSH Agent forwarding (recommended for security)
      - SSH_AUTH_SOCK=${SSH_AUTH_SOCK}

      # GitHub Token (alternative to SSH)
      # You can pass this via terminal: GITHUB_TOKEN=$(gh auth token) docker-compose run ...
      - GITHUB_TOKEN=${GITHUB_TOKEN:-}

      # -----------------------------------------------------------------------
      # Key fix: redirect uv's venv to a container-only location.
      # Without this, 'uv sync' inside Docker writes .venv at /app/.venv and
      # the activate script hardcodes VIRTUAL_ENV="/app/.venv". When the user
      # sources that venv on their host machine, uv warns about the path
      # mismatch on every subsequent 'uv sync' run.
      # By pointing UV_PROJECT_ENVIRONMENT to /opt/..., the host .venv is
      # never touched by Docker, so the host venv stays clean.
      - UV_PROJECT_ENVIRONMENT=/opt/ac_cdd_project_venv

      # Flag for ac-cdd code to detect it is running inside Docker
      - DOCKER_CONTAINER=true
      # -----------------------------------------------------------------------

      # Configuration Examples (Override here if needed)
      # - AC_CDD_REVIEWER__SMART_MODEL=openrouter/anthropic/claude-3-5-sonnet

      # Final Resort for Git Identity (if still facing issues)
      # - GIT_AUTHOR_NAME=AC-CDD-Agent
      # - GIT_AUTHOR_EMAIL=agent@ac-cdd.com

      # Keep container alive or run command
      # entrypoint.sh is the entrypoint, CMD is passed to it
    command: [ "ac-cdd" ]

    # Interactive mode support
    stdin_open: true
    tty: true
